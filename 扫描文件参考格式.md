# 文件扫描参考格式和配置指南

## 1. 自动扫描配置

### 环境变量配置
```bash
# 设置自动扫描目录（相对路径或绝对路径）
AUTO_SCAN_DIRECTORY=../knowledge_01/files

# 是否自动构建索引（true/false）
AUTO_BUILD_INDEX=true
```

### 在代码中的配置
```python
# app.py 中的配置
AUTO_SCAN_DIRECTORY = os.environ.get('AUTO_SCAN_DIRECTORY', '../knowledge_01/files')
AUTO_BUILD_INDEX = os.environ.get('AUTO_BUILD_INDEX', 'true').lower() == 'true'
```

## 2. 支持的文件格式

### 默认支持格式
- `.md` - Markdown 文件（主要格式）
- `.txt` - 纯文本文件

### 文件匹配模式
```python
# 扫描所有 .md 文件
file_pattern = "*.md"

# 递归扫描子目录中的 .md 文件
file_pattern = "**/*.md"

# 扫描特定前缀的文件
file_pattern = "paper_*.md"
```

## 3. 目录结构示例

```
knowledge_01/
├── files/
│   ├── paper1.md
│   ├── paper2.md
│   ├── research/
│   │   ├── study1.md
│   │   └── study2.md
│   └── notes/
│       ├── note1.md
│       └── note2.md
```

## 4. 自动初始化流程

### 系统启动时的自动处理
1. **检查配置**: 验证 `AUTO_SCAN_DIRECTORY` 是否存在
2. **检查数据库**: 如果数据库已有数据，跳过自动初始化
3. **扫描文件**: 使用 `glob` 模式匹配文件
4. **处理文件**: 逐个处理找到的文件
5. **构建索引**: 如果启用 `AUTO_BUILD_INDEX`，自动构建搜索索引

### 日志输出示例
```
INFO - 开始自动扫描目录: ../knowledge_01/files
INFO - 找到 15 个文件待处理
INFO - 批量处理完成，总共处理 1250 个句子
INFO - 自动初始化完成：处理了 15 个文件，共 1250 个句子
INFO - 开始自动构建搜索索引...
INFO - 搜索索引构建完成
```

## 5. 手动扫描方式

### 使用 API 接口
```python
# 通过编程方式调用
embedding_processor = SentenceEmbeddingProcessor()
results = embedding_processor.process_directory(
    directory_path="../knowledge_01/files",
    file_pattern="*.md",
    batch_size=32
)
```

### 返回结果格式
```python
{
    "/path/to/file1.md": 45,  # 处理的句子数量
    "/path/to/file2.md": 32,
    "/path/to/file3.md": 0,   # 处理失败或无内容
}
```

## 6. 文件内容要求

### Markdown 文件格式
- 支持标准 Markdown 语法
- 自动清理 Markdown 标记（#, *, [], () 等）
- 按句子分割（基于句号、问号、感叹号）
- 过滤过短的句子（少于10个字符）

### 句子提取规则
```python
# 句子分割模式
sentence_pattern = r'[.!?]+\s+'

# 清理规则
- 移除 Markdown 标题标记 (#)
- 移除链接格式 [text](url)
- 移除粗体/斜体标记 (**, *, __)
- 移除代码块标记 (```)
- 保留中文标点符号
```

## 7. 配置文件示例

### 创建 .env 文件
```bash
# .env
AUTO_SCAN_DIRECTORY=E:\My\tex\knowledge_01\files
AUTO_BUILD_INDEX=true
UPLOAD_FOLDER=uploads
MAX_CONTENT_LENGTH=16777216
```

### PowerShell 环境变量设置
```powershell
# 临时设置（当前会话）
$env:AUTO_SCAN_DIRECTORY = "E:\My\tex\knowledge_01\files"
$env:AUTO_BUILD_INDEX = "true"

# 永久设置（系统环境变量）
[Environment]::SetEnvironmentVariable("AUTO_SCAN_DIRECTORY", "E:\My\tex\knowledge_01\files", "User")
[Environment]::SetEnvironmentVariable("AUTO_BUILD_INDEX", "true", "User")
```

## 8. 错误处理

### 常见错误和解决方案

1. **目录不存在**
   ```
   错误: 自动扫描目录不存在或未配置
   解决: 检查路径是否正确，使用绝对路径
   ```

2. **文件权限问题**
   ```
   错误: Permission denied
   解决: 确保程序有读取文件的权限
   ```

3. **文件编码问题**
   ```
   错误: UnicodeDecodeError
   解决: 确保文件使用 UTF-8 编码
   ```

## 9. 性能优化建议

### 批处理设置
```python
# 调整批处理大小以优化性能
batch_size = 32  # 默认值，可根据内存情况调整
```

### 大量文件处理
- 建议分批处理大量文件
- 监控内存使用情况
- 考虑使用进度条显示处理状态

## 10. 使用示例

### 启动应用时自动扫描
```bash
# 设置环境变量后启动
set AUTO_SCAN_DIRECTORY=E:\My\tex\knowledge_01\files
set AUTO_BUILD_INDEX=true
python app.py
```

### 手动触发扫描
```python
# 在 Python 代码中
from embedding_processor import SentenceEmbeddingProcessor

processor = SentenceEmbeddingProcessor()
results = processor.process_directory("./documents", "*.md")
print(f"处理完成，共处理 {sum(results.values())} 个句子")
```